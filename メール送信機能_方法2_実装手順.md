# メール送信機能の実装手順（方法2: Firebase Functionsで直接メール送信）

## 実装状況
✅ Firebase Functionsのコード実装完了
✅ nodemailerパッケージインストール完了
✅ クライアント側のコード実装完了

## 次のステップ

### 1. SMTPサーバーの準備

以下のいずれかのSMTPサーバーを準備してください：

#### オプションA: SendGridを使用（推奨）
1. SendGridアカウントを作成: https://sendgrid.com/
2. APIキーを取得:
   - SendGridダッシュボード → Settings → API Keys
   - "Create API Key"をクリック
   - 名前を入力（例: "Firebase Functions"）
   - "Full Access"または"Mail Send"権限を選択
   - APIキーをコピー（表示されるのは一度だけなので注意）

#### オプションB: Gmailを使用
1. Gmailアカウントで2段階認証を有効化
2. アプリパスワードを生成:
   - Googleアカウント設定 → セキュリティ → 2段階認証プロセス
   - アプリパスワードを生成
   - 16文字のパスワードをコピー

#### オプションC: その他のSMTPサーバー
- Mailgun、Amazon SES、その他のSMTPサーバーも使用可能

---

### 2. Firebaseコンソールで環境変数を設定

1. **Firebaseコンソールにアクセス**
   - https://console.firebase.google.com/
   - プロジェクト「kensyu10117」を選択

2. **Functionsの設定画面を開く**
   - 左メニューから「Functions」を選択
   - 「設定」タブをクリック
   - 「環境変数」セクションを開く

3. **環境変数を追加**
   以下の環境変数を追加してください：

   | 変数名 | 値の例 | 説明 |
   |--------|--------|------|
   | `SMTP_HOST` | `smtp.sendgrid.net` または `smtp.gmail.com` | SMTPサーバーのホスト名 |
   | `SMTP_PORT` | `587` | SMTPポート番号（通常は587） |
   | `SMTP_USER` | SendGrid: `apikey`<br>Gmail: `your-email@gmail.com` | SMTPユーザー名 |
   | `SMTP_PASSWORD` | SendGrid: 取得したAPIキー<br>Gmail: アプリパスワード | SMTPパスワード |
   | `SMTP_FROM` | `noreply@yourcompany.com` | 送信元メールアドレス |

   **SendGridを使用する場合の設定例：**
   ```
   SMTP_HOST = smtp.sendgrid.net
   SMTP_PORT = 587
   SMTP_USER = apikey
   SMTP_PASSWORD = SG.xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
   SMTP_FROM = noreply@yourcompany.com
   ```

   **Gmailを使用する場合の設定例：**
   ```
   SMTP_HOST = smtp.gmail.com
   SMTP_PORT = 587
   SMTP_USER = your-email@gmail.com
   SMTP_PASSWORD = xxxx xxxx xxxx xxxx（16文字のアプリパスワード）
   SMTP_FROM = your-email@gmail.com
   ```

4. **環境変数を保存**
   - 各変数を追加後、「保存」をクリック

---

### 3. Firebase Functionsをデプロイ

ターミナルで以下のコマンドを実行：

```bash
cd functions
npm run build
firebase deploy --only functions
```

**注意**: 初回デプロイ時は、Firebase CLIでログインが必要な場合があります：
```bash
firebase login
```

---

### 4. 動作確認

1. **アプリで社員を追加**
   - 入社手続きページで「社員を追加」ボタンをクリック
   - 社員情報と初期パスワードを入力
   - 「追加」ボタンをクリック

2. **メール送信の確認**
   - 入力したメールアドレスにメールが届くか確認
   - メールには以下の内容が含まれます：
     - 件名: 「入社手続きのご案内」
     - 本文: アプリのURLと初期パスワード

3. **エラーの確認**
   - メールが届かない場合、Firebaseコンソールでログを確認：
     - Functions → ログ
     - エラーメッセージを確認

---

### 5. トラブルシューティング

#### メールが送信されない場合

1. **環境変数の確認**
   - Firebaseコンソールで環境変数が正しく設定されているか確認
   - 変数名にタイポがないか確認
   - 値が正しいか確認（特にパスワード）

2. **Firebase Functionsのログを確認**
   - Firebaseコンソール → Functions → ログ
   - エラーメッセージを確認

3. **SMTP設定の確認**
   - SendGrid: APIキーが正しいか、権限が適切か確認
   - Gmail: アプリパスワードが正しいか、2段階認証が有効か確認

4. **フォールバック機能**
   - SMTP送信に失敗した場合、自動的にFirestoreの`mail`コレクションに保存されます
   - Trigger Email拡張機能がインストールされていれば、そこから送信されます

#### よくあるエラー

- **"Invalid login"**: SMTP_USERまたはSMTP_PASSWORDが間違っています
- **"Connection timeout"**: SMTP_HOSTまたはSMTP_PORTが間違っています
- **"Authentication failed"**: 認証情報が正しくありません

---

## セキュリティに関する注意事項

1. **環境変数の保護**
   - 環境変数には機密情報（APIキー、パスワード）が含まれます
   - これらの情報をGitにコミットしないでください
   - `.env`ファイルは`.gitignore`に追加してください

2. **送信元メールアドレスの設定**
   - `SMTP_FROM`には、SMTPサーバーで認証済みのメールアドレスを設定してください
   - SendGrid: 送信元メールアドレスを認証する必要があります

---

## 参考リンク

- [Firebase Functions環境変数の設定](https://firebase.google.com/docs/functions/config-env)
- [SendGrid公式サイト](https://sendgrid.com/)
- [Gmailアプリパスワードの設定](https://support.google.com/accounts/answer/185833)
- [nodemailer公式ドキュメント](https://nodemailer.com/)

