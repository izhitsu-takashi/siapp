# 申請機能のテストケースと期待値

## 概要
労務担当者と従業員画面で申請を行った時にデータが正しくやり取りされているかを、具体的な期待値を用いて様々なパターンでテストしています。

---

## 従業員側テスト (`employee-dashboard.component.spec.ts`)

### 1. 扶養家族追加申請 - 配偶者の場合

#### 1.1 配偶者の基本情報が正しく保存されること
**テストデータ:**
- 続柄種別: 配偶者
- 続柄: 妻
- 氏名: 山田 花子
- 生年月日: 1990-01-01
- 基礎年金番号: 12345678
- 同居/別居: 同居
- 被扶養者になった日: 2024-01-01
- 理由: 婚姻
- 職業: 無職
- 年収見込み額: 0円

**期待値:**
- `employeeNumber`: 'EMP001'
- `applicationType`: '扶養家族追加'
- `relationshipType`: '配偶者'
- `spouseType`: '妻'
- `lastName`: '山田'
- `firstName`: '花子'
- `basicPensionNumber`: '12345678'
- `livingTogether`: '同居'
- `dependentStartDate`: '2024-01-01'
- `dependentReason`: '婚姻'
- `occupation`: '無職'
- `annualIncome`: '0'

#### 1.2 配偶者で外国籍の場合、国籍と通称名が正しく保存されること
**テストデータ:**
- 続柄種別: 配偶者
- 続柄: 夫
- 氏名: Smith John
- 外国籍: はい
- 国籍: アメリカ
- 通称名: ジョン・スミス

**期待値:**
- `isForeignNational`: 'はい'
- `nationality`: 'アメリカ'
- `aliasName`: 'ジョン・スミス'

#### 1.3 配偶者で別居の場合、住所情報と仕送り額が正しく保存されること
**テストデータ:**
- 同居/別居: 別居
- 郵便番号: 123-4567
- 住所: 東京都渋谷区1-2-3
- 毎月の仕送り額: 50000円

**期待値:**
- `livingTogether`: '別居'
- `postalCode`: '123-4567'
- `address`: '東京都渋谷区1-2-3'
- `monthlySupportAmount`: '50000'

---

### 2. 扶養家族追加申請 - 配偶者以外の場合

#### 2.1 配偶者以外で続柄が「実子・養子」の場合、正しく保存されること
**テストデータ:**
- 続柄種別: 配偶者以外
- 続柄: 実子・養子
- 性別: 男性
- マイナンバー: 123456789012
- 職業: 小中学生
- 配偶者の年収: 3000000円

**期待値:**
- `relationshipType`: '配偶者以外'
- `relationship`: '実子・養子'
- `gender`: '男性'
- `myNumber`: '123456789012'
- `occupation`: '小中学生'
- `spouseAnnualIncome`: '3000000'

#### 2.2 配偶者以外で続柄が「その他」の場合、relationshipOtherが正しく保存されること
**テストデータ:**
- 続柄: その他
- 続柄その他: 義理の兄弟
- 理由: その他
- 理由その他: 特別な事情

**期待値:**
- `relationship`: '義理の兄弟' (relationshipOtherの値がrelationshipに統合される)
- `dependentReason`: '特別な事情' (dependentReasonOtherの値がdependentReasonに統合される)
- `dependentReasonOther`: '特別な事情'

#### 2.3 配偶者以外で職業が「大学生」の場合、学年が正しく保存されること
**テストデータ:**
- 職業: 大学生
- 学年: 2年

**期待値:**
- `occupation`: '大学生'
- `studentYear`: '2年'

#### 2.4 配偶者以外で職業が「その他」の場合、occupationOtherが正しく保存されること
**テストデータ:**
- 職業: その他
- 職業その他: 自営業

**期待値:**
- `occupation`: '自営業' (occupationOtherの値がoccupationに統合される)
- `occupationOther`: '自営業'

---

### 3. 退職申請

#### 3.1 退職申請の基本情報が正しく保存されること
**テストデータ:**
- 退職日: 未来の日付（動的生成）
- 最終出社日: 未来の日付（動的生成）
- 退職理由: 転職のため
- 離職票: あり
- 退職後の連絡先住所: 東京都港区4-5-6
- 退職後の電話番号: 080-1111-2222
- 退職後のメールアドレス: newemail@example.com
- 退職後の保険: 国民健康保険
- 変更なしフラグ: すべてfalse

**期待値:**
- `applicationType`: '退職申請'
- `resignationDate`: 未来の日付
- `lastWorkDate`: 未来の日付
- `resignationReason`: '転職のため'
- `separationNotice`: 'あり'
- `postResignationAddress`: '東京都港区4-5-6'
- `postResignationPhone`: '080-1111-2222'
- `postResignationEmail`: 'newemail@example.com'
- `postResignationInsurance`: '国民健康保険'
- `sameAsCurrentAddress`: false
- `sameAsCurrentPhone`: false
- `sameAsCurrentEmail`: false

#### 3.2 退職申請で連絡先が変更なしの場合、現在の連絡先情報が使用されること
**テストデータ:**
- 変更なしフラグ: すべてtrue
- 現在の連絡先情報:
  - 住所: 東京都新宿区1-2-3
  - 電話: 090-1234-5678
  - メール: test@example.com

**期待値:**
- `postResignationAddress`: '東京都新宿区1-2-3'
- `postResignationPhone`: '090-1234-5678'
- `postResignationEmail`: 'test@example.com'
- `sameAsCurrentAddress`: true
- `sameAsCurrentPhone`: true
- `sameAsCurrentEmail`: true

---

## 労務側テスト (`hr-dashboard.component.spec.ts`)

### 1. 申請の取得と表示

#### 1.1 扶養家族追加申請（配偶者）が正しく取得・表示されること
**テストデータ:**
- 申請ID: APP001
- 申請種類: 扶養家族追加
- 続柄種別: 配偶者
- 続柄: 妻
- 氏名: 山田 花子

**期待値:**
- `allApplications.length`: 1
- `applicationType`: '扶養家族追加'
- `relationshipType`: '配偶者'
- `spouseType`: '妻'
- `lastName`: '山田'
- `firstName`: '花子'
- `employeeName`: 'テスト太郎'

#### 1.2 扶養家族追加申請（配偶者以外、その他選択）が正しく取得・表示されること
**テストデータ:**
- 続柄種別: 配偶者以外
- 続柄: その他
- 続柄その他: 義理の兄弟
- 理由: その他
- 理由その他: 特別な事情

**期待値:**
- `relationshipType`: '配偶者以外'
- `relationship`: 'その他'
- `relationshipOther`: '義理の兄弟'
- `dependentReason`: 'その他'
- `dependentReasonOther`: '特別な事情'

#### 1.3 扶養家族追加申請（配偶者以外、大学生）が正しく取得・表示されること
**テストデータ:**
- 職業: 大学生
- 学年: 2年

**期待値:**
- `occupation`: '大学生'
- `studentYear`: '2年'

#### 1.4 退職申請が正しく取得・表示されること
**テストデータ:**
- 申請種類: 退職申請
- 退職日: 2024-12-31
- 退職理由: 転職のため

**期待値:**
- `applicationType`: '退職申請'
- `resignationDate`: '2024-12-31'
- `resignationReason`: '転職のため'
- `postResignationAddress`: '東京都港区4-5-6'

---

### 2. 申請ステータスの更新

#### 2.1 申請を「承認済み」に更新できること
**テストデータ:**
- 申請ID: APP001
- ステータス: 承認済み
- コメント: （なし）

**期待値:**
- `updateApplicationStatus`が以下の引数で呼ばれる:
  - `applicationId`: 'APP001'
  - `status`: '承認済み'
  - `comment`: ''

#### 2.2 申請を「差し戻し」に更新し、コメントが保存されること
**テストデータ:**
- ステータス: 差し戻し
- コメント: 必須項目が不足しています

**期待値:**
- `updateApplicationStatus`が以下の引数で呼ばれる:
  - `applicationId`: 'APP001'
  - `status`: '差し戻し'
  - `comment`: '必須項目が不足しています'

#### 2.3 申請を「取り消し」に更新できること
**テストデータ:**
- 申請ID: APP001
- ステータス: 取り消し

**期待値:**
- `updateApplicationStatus`が以下の引数で呼ばれる:
  - `applicationId`: 'APP001'
  - `status`: '取り消し'
  - `comment`: ''

---

### 3. 申請フィルタリング

#### 3.1-3.5 ステータスフィルターで正しくフィルタリングされること
**テストデータ:**
- 4件の申請（承認待ち、承認済み、差し戻し、取り消し各1件）

**期待値:**
- 「承認待ち」フィルター: 1件（承認待ちのみ）
- 「承認済み」フィルター: 1件（承認済みのみ）
- 「差し戻し」フィルター: 1件（差し戻しのみ）
- 「取り消し」フィルター: 1件（取り消しのみ）
- 「すべて」フィルター: 4件（全申請）

---

### 4. データ整合性チェック

#### 4.1 扶養家族追加申請で「その他」が選択された場合、relationshipOtherが存在すること
**期待値:**
- `relationship`: 'その他'
- `relationshipOther`: '義理の兄弟'
- `relationshipOther`が存在する（truthy）

#### 4.2 扶養家族追加申請で職業が「大学生」の場合、studentYearが存在すること
**期待値:**
- `occupation`: '大学生'
- `studentYear`: '2年'
- `studentYear`が存在する（truthy）

#### 4.3 扶養家族追加申請で職業が「その他」の場合、occupationOtherが存在すること
**期待値:**
- `occupation`: 'その他'
- `occupationOther`: '自営業'
- `occupationOther`が存在する（truthy）

---

## データ保存ロジックの重要なポイント

1. **「その他」選択時の処理:**
   - 続柄が「その他」の場合: `relationshipOther`の値が`relationship`に統合される
   - 職業が「その他」の場合: `occupationOther`の値が`occupation`に統合される
   - 理由が「その他」の場合: `dependentReasonOther`の値が`dependentReason`に統合される

2. **マイナンバーと基礎年金番号:**
   - 複数のパート（Part1, Part2, Part3）が結合されて保存される

3. **退職申請の連絡先情報:**
   - 変更なしフラグがtrueの場合、現在の連絡先情報が使用される

4. **ステータス:**
   - 申請のステータスは`FirestoreService.saveApplication`内で'承認待ち'に設定される

---

## 申請詳細モーダル - 照会モードと編集モードの切り替えテスト (`application-detail-modal-mode-switch.spec.ts`)

### 概要
申請詳細モーダルで照会モードと編集モードを切り替えたときに、データが正しく保持されるかを全ての申請タイプでテストします。特に「その他」を選択している場合も含めてテストします。

---

### 1. 扶養家族追加申請 - 照会モードと編集モードの切り替え

#### 1.1 照会モードから編集モードに切り替えたとき、基本データが正しく保持されること
**テストデータ:**
- 続柄種別: 配偶者
- 続柄: 妻
- 氏名: 山田 花子
- 基礎年金番号: 12345678

**期待値:**
- フォームが正しく初期化される
- `isEditModeForReapplication`が`true`になる
- 全ての基本データがフォームに正しく設定される
- 基礎年金番号が分割されて設定される（Part1: '1234', Part2: '5678'）

#### 1.2 照会モードから編集モードに切り替えたとき、「その他」選択のデータが正しく保持されること
**テストデータ:**
- 続柄: 義理の兄弟（「その他」の値が直接保存されている）
- 理由: 特別な事情（「その他」の値が直接保存されている）
- 職業: 自営業（「その他」の値が直接保存されている）

**期待値:**
- `relationship`が「その他」に変換される
- `relationshipOther`に元の値（'義理の兄弟'）が設定される
- `dependentReason`が「その他」に変換される
- `dependentReasonOther`に元の値（'特別な事情'）が設定される
- `occupation`が「その他」に変換される
- `occupationOther`に元の値（'自営業'）が設定される

#### 1.3 照会モードから編集モードに切り替えたとき、大学生の学年が正しく保持されること
**テストデータ:**
- 職業: 大学生
- 学年: 2年

**期待値:**
- `occupation`が'大学生'のまま保持される
- `studentYear`が'2年'のまま保持される

#### 1.4 照会モードから編集モードに切り替えたとき、海外居住者「その他」選択のデータが正しく保持されること
**テストデータ:**
- 海外居住者: はい
- 海外特例要件に該当した日: 2024-05-15
- 海外理由: 特別な理由（「その他」の値が直接保存されている）

**期待値:**
- `isOverseasResident`が'はい'のまま保持される
- `overseasSpecialRequirementDate`が'2024-05-15'のまま保持される
- `overseasReason`が「その他」に変換される
- `overseasReasonOther`に元の値（'特別な理由'）が設定される

#### 1.5 編集モードから照会モードに戻したとき、データが正しく保持されること
**期待値:**
- フォームの値を変更しても、`selectedApplication`のデータは変更されない
- 照会モードに戻したとき、元のデータが表示される

---

### 2. 退職申請 - 照会モードと編集モードの切り替え

#### 2.1 照会モードから編集モードに切り替えたとき、基本データが正しく保持されること
**テストデータ:**
- 退職日: 未来の日付
- 最終出社日: 未来の日付
- 退職理由: 転職のため
- 退職後の連絡先情報

**期待値:**
- 全ての基本データがフォームに正しく設定される
- 変更なしフラグが正しく設定される

#### 2.2 照会モードから編集モードに切り替えたとき、変更なしフラグが正しく保持されること
**テストデータ:**
- 変更なしフラグ: すべてtrue
- 現在の連絡先情報が使用される

**期待値:**
- `sameAsCurrentAddressForResignation`が`true`になる
- `sameAsCurrentPhoneForResignation`が`true`になる
- `sameAsCurrentEmailForResignation`が`true`になる

---

### 3. 扶養削除申請 - 照会モードと編集モードの切り替え

#### 3.1 照会モードから編集モードに切り替えたとき、基本データが正しく保持されること
**テストデータ:**
- 削除日: 2024-08-01
- 削除理由: 離婚

**期待値:**
- 全ての基本データがフォームに正しく設定される

#### 3.2 照会モードから編集モードに切り替えたとき、「その他」選択のデータが正しく保持されること
**テストデータ:**
- 削除理由: 特別な理由（「その他」の値が直接保存されている）

**期待値:**
- `removalReason`が「その他」に変換される
- `removalReasonOther`に元の値（'特別な理由'）が設定される

#### 3.3 照会モードから編集モードに切り替えたとき、海外居住者「その他」選択のデータが正しく保持されること
**テストデータ:**
- 海外居住者: はい
- 海外非資格日: 2024-09-15
- 海外理由: 特別な理由（「その他」の値が直接保存されている）

**期待値:**
- `isOverseasResident`が'はい'のまま保持される
- `overseasNonQualificationDate`が'2024-09-15'のまま保持される
- `overseasReason`が「その他」に変換される
- `overseasReasonOther`に元の値（'特別な理由'）が設定される

---

### 4. 住所変更申請 - 照会モードと編集モードの切り替え

#### 4.1 照会モードから編集モードに切り替えたとき、基本データが正しく保持されること
**テストデータ:**
- 転居日: 2024-10-01
- 新住所情報
- 住民票住所情報

**期待値:**
- 全ての基本データがフォームに正しく設定される
- チェックボックスフラグが正しく設定される

---

### 5. 氏名変更申請 - 照会モードと編集モードの切り替え

#### 5.1 照会モードから編集モードに切り替えたとき、基本データが正しく保持されること
**テストデータ:**
- 変更日: 2024-11-01
- 新氏名情報

**期待値:**
- 全ての基本データがフォームに正しく設定される

---

### 6. 産前産後休業申請 - 照会モードと編集モードの切り替え

#### 6.1 照会モードから編集モードに切り替えたとき、基本データが正しく保持されること
**テストデータ:**
- 出産予定日: 2024-12-01
- 双子以上か: いいえ
- 休業期間
- 滞在先

**期待値:**
- 全ての基本データがフォームに正しく設定される

---

### 7. マイナンバー変更申請 - 照会モードと編集モードの切り替え

#### 7.1 照会モードから編集モードに切り替えたとき、基本データが正しく保持されること
**テストデータ:**
- 変更日: 2024-12-15
- 新マイナンバー（Part1, Part2, Part3）

**期待値:**
- 全ての基本データがフォームに正しく設定される
- マイナンバーが分割されて設定される

---

### 8. 入社時申請 - 照会モードと編集モードの切り替え

#### 8.1 照会モードから編集モードに切り替えたとき、基本データが正しく保持されること
**テストデータ:**
- 基本情報（氏名、生年月日、性別、メールアドレス）
- マイナンバー（分割）
- 基礎年金番号（分割）
- 緊急連絡先（ネストされたフォームグループ）
- 銀行口座情報（ネストされたフォームグループ）

**期待値:**
- 全ての基本データがフォームに正しく設定される
- マイナンバーと基礎年金番号が分割されて設定される
- ネストされたフォームグループのデータも正しく設定される
- 姓・名・メールアドレスが編集不可のまま保持される

---

## モード切り替えテストの重要なポイント

1. **「その他」選択時のデータ変換:**
   - 保存時に「その他」の値が直接保存されている場合、編集モードに切り替えたときに「その他」に変換され、元の値が`*Other`フィールドに設定される

2. **データの分割:**
   - マイナンバーや基礎年金番号など、結合された値が分割されてフォームに設定される

3. **ネストされたフォームグループ:**
   - 緊急連絡先や銀行口座情報など、ネストされたフォームグループのデータも正しく保持される

4. **編集不可フィールド:**
   - 入社時申請の姓・名・メールアドレスなど、編集不可のフィールドが正しく無効化される

5. **チェックボックスフラグ:**
   - 変更なしフラグや同じ住所フラグなど、チェックボックスの状態が正しく保持される

