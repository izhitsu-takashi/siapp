<div class="dashboard-wrapper">
  <!-- ヘッダー -->
  <header class="dashboard-header">
    <div class="header-left">
      <h1 class="app-name">SIApp</h1>
    </div>
    <div class="header-right">
      <span class="user-info">
        <span class="user-name">{{ userName }}</span>
      </span>
      <button class="logout-button" (click)="logout()" [disabled]="isSavingSalary || isSavingBonus">ログアウト</button>
    </div>
  </header>

  <!-- メインコンテンツエリア -->
  <div class="dashboard-body">
    <!-- サイドバー -->
    <aside class="sidebar">
      <nav class="sidebar-nav">
        <button
          *ngFor="let tab of tabs"
          class="sidebar-item"
          [class.active]="currentTab === tab.name"
          [disabled]="isSavingSalary || isSavingBonus"
          (click)="switchTab(tab.name)"
        >
          {{ tab.name }}
        </button>
      </nav>
    </aside>

    <!-- メインコンテンツ -->
    <main class="main-content">
      <div class="content-area">
        <!-- 社会保険料ページ -->
        <ng-container *ngIf="currentTab === '社会保険料'">
          <div class="insurance-list-page">
            <!-- フィルターと切り替え -->
            <div class="insurance-list-controls">
              <div class="filter-group">
                <label>表示タイプ:</label>
                <button 
                  class="toggle-button" 
                  [class.active]="insuranceListType === 'salary'"
                  (click)="switchInsuranceListType('salary')"
                >
                  給与
                </button>
                <button 
                  class="toggle-button" 
                  [class.active]="insuranceListType === 'bonus'"
                  (click)="switchInsuranceListType('bonus')"
                >
                  賞与
                </button>
              </div>
              <div class="filter-group">
                <label>年月:</label>
                <select 
                  [(ngModel)]="insuranceListYear" 
                  (change)="onInsuranceListDateChange()"
                  class="year-select"
                >
                  <option *ngFor="let year of availableYears" [value]="year">{{ year }}</option>
                </select>
                <span>年</span>
                <select 
                  [(ngModel)]="insuranceListMonth" 
                  (change)="onInsuranceListDateChange()"
                  class="month-select"
                >
                  <option *ngFor="let month of availableMonths" [value]="month">{{ month }}</option>
                </select>
                <span>月</span>
              </div>
            </div>
            
            <!-- 事業主負担額合計 -->
            <div class="employer-burden-summary" *ngIf="!isLoadingInsuranceList">
              <div class="summary-card">
                <span class="summary-label">事業主負担額合計:</span>
                <span class="summary-value">{{ getTotalEmployerBurden() | number:'1.0-0' }}円</span>
              </div>
            </div>
            
            <!-- 給与テーブル -->
            <div class="table-container" *ngIf="insuranceListType === 'salary'">
              <div *ngIf="isLoadingInsuranceList" class="loading-message">
                データを読み込み中です...
              </div>
              <table class="insurance-table" *ngIf="!isLoadingInsuranceList">
                <thead>
                  <tr>
                    <th>社員番号</th>
                    <th class="name-column">氏名</th>
                    <th>固定的賃金</th>
                    <th>標準報酬月額</th>
                    <th>健康保険料</th>
                    <th>介護保険料</th>
                    <th>厚生年金保険料</th>
                    <th>社員負担額</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let item of filteredInsuranceList; trackBy: trackByEmployeeNumber" 
                      (click)="openEmployeeInfoModal(item.employeeNumber)"
                      class="clickable-row">
                    <td>{{ item.employeeNumber }}</td>
                    <td class="name-column">{{ item.name }}</td>
                    <td class="number-cell">{{ item.fixedSalary | number:'1.0-0' }}円</td>
                    <td class="number-cell">{{ item.standardMonthlySalary | number:'1.0-0' }}円</td>
                    <td class="number-cell">{{ formatInsuranceAmount(item.healthInsurance) }}円</td>
                    <td class="number-cell">{{ formatInsuranceAmount(item.nursingInsurance) }}円</td>
                    <td class="number-cell">{{ formatInsuranceAmount(item.pensionInsurance) }}円</td>
                    <td class="number-cell total-cell">{{ item.employeeBurden | number:'1.0-0' }}円</td>
                  </tr>
                  <tr *ngIf="filteredInsuranceList.length === 0">
                    <td colspan="8" class="empty-message">データがありません</td>
                  </tr>
                </tbody>
                <tfoot>
                  <tr class="total-row">
                    <td colspan="3" class="total-label">合計</td>
                    <td></td>
                    <td class="total-value number-cell">{{ formatInsuranceAmount(getTotalHealthInsurance()) }}円</td>
                    <td class="total-value number-cell">{{ formatInsuranceAmount(getTotalNursingInsurance()) }}円</td>
                    <td class="total-value number-cell">{{ formatInsuranceAmount(getTotalPensionInsurance()) }}円</td>
                    <td class="total-value number-cell">{{ getTotalEmployeeBurden() | number:'1.0-0' }}円</td>
                  </tr>
                </tfoot>
              </table>
            </div>

            <!-- 賞与テーブル -->
            <div class="table-container" *ngIf="insuranceListType === 'bonus'">
              <div *ngIf="isLoadingInsuranceList" class="loading-message">
                データを読み込み中です...
              </div>
              <table class="insurance-table" *ngIf="!isLoadingInsuranceList">
                <thead>
                  <tr>
                    <th>社員番号</th>
                    <th class="name-column">氏名</th>
                    <th>賞与額</th>
                    <th>標準賞与額</th>
                    <th>健康保険料</th>
                    <th>介護保険料</th>
                    <th>厚生年金保険料</th>
                    <th>社員負担額</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let item of filteredInsuranceList; trackBy: trackByEmployeeNumber" 
                      (click)="openEmployeeInfoModal(item.employeeNumber)"
                      class="clickable-row">
                    <td>{{ item.employeeNumber }}</td>
                    <td class="name-column">{{ item.name }}</td>
                    <td class="number-cell">{{ item.bonusAmount | number:'1.0-0' }}円</td>
                    <td class="number-cell">{{ item.standardBonusAmount | number:'1.0-0' }}円</td>
                    <td class="number-cell">{{ formatInsuranceAmount(item.healthInsurance) }}円</td>
                    <td class="number-cell">{{ formatInsuranceAmount(item.nursingInsurance) }}円</td>
                    <td class="number-cell">{{ formatInsuranceAmount(item.pensionInsurance) }}円</td>
                    <td class="number-cell total-cell">{{ item.employeeBurden | number:'1.0-0' }}円</td>
                  </tr>
                  <tr *ngIf="filteredInsuranceList.length === 0">
                    <td colspan="8" class="empty-message">データがありません</td>
                  </tr>
                </tbody>
                <tfoot>
                  <tr class="total-row">
                    <td colspan="4" class="total-label">合計</td>
                    <td class="total-value number-cell">{{ formatInsuranceAmount(getTotalHealthInsurance()) }}円</td>
                    <td class="total-value number-cell">{{ formatInsuranceAmount(getTotalNursingInsurance()) }}円</td>
                    <td class="total-value number-cell">{{ formatInsuranceAmount(getTotalPensionInsurance()) }}円</td>
                    <td class="total-value number-cell">{{ getTotalEmployeeBurden() | number:'1.0-0' }}円</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </ng-container>

        <!-- 給与ページ -->
        <ng-container *ngIf="currentTab === '給与'">
          <!-- 給与設定フォーム -->
          <div class="form-container">
            <form class="salary-form" (ngSubmit)="saveSalary()">
              <div class="form-row-wide">
                <div class="form-group">
                  <label for="salaryEmployee">社員 <span class="required">*</span></label>
                  <select 
                    id="salaryEmployee" 
                    [(ngModel)]="selectedSalaryEmployee" 
                    name="salaryEmployee"
                    class="form-input"
                    [disabled]="isSavingSalary"
                    required
                  >
                    <option value="">選択してください</option>
                    <option *ngFor="let emp of salaryEmployees" [value]="emp.employeeNumber">
                      {{ emp.employeeNumber }} - {{ emp.name }}
                    </option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="salaryYear">年 <span class="required">*</span></label>
                  <select 
                    id="salaryYear" 
                    [(ngModel)]="salaryYear" 
                    name="salaryYear"
                    class="form-input"
                    [disabled]="isSavingSalary"
                    required
                  >
                    <option *ngFor="let year of availableYears" [value]="year">{{ year }}</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="salaryMonth">月 <span class="required">*</span></label>
                  <select 
                    id="salaryMonth" 
                    [(ngModel)]="salaryMonth" 
                    name="salaryMonth"
                    class="form-input"
                    [disabled]="isSavingSalary"
                    required
                  >
                    <option *ngFor="let month of availableMonths" [value]="month">{{ month }}</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="salaryAmount">固定的賃金額（円） <span class="required">*</span></label>
                  <input 
                    type="number" 
                    id="salaryAmount" 
                    [(ngModel)]="salaryAmount" 
                    name="salaryAmount"
                    class="form-input"
                    [disabled]="isSavingSalary"
                    min="1"
                    step="1"
                    (input)="onSalaryAmountInput($event)"
                    required
                  >
                </div>
                <div class="form-group form-group-button">
                  <button type="submit" class="submit-button" [disabled]="isSavingSalary">
                    {{ isSavingSalary ? '設定中...' : '給与を設定' }}
                  </button>
                </div>
              </div>
              
              <!-- 進行状況表示 -->
              <div *ngIf="isSavingSalary && salarySaveProgress.message" class="salary-progress-container">
                <div class="progress-message">{{ salarySaveProgress.message }}</div>
                <div class="progress-bar-container">
                  <div class="progress-bar" [style.width.%]="salarySaveProgress.progress"></div>
                </div>
                <div class="progress-percentage">{{ salarySaveProgress.progress }}%</div>
              </div>
            </form>
          </div>

          <!-- 給与履歴表 -->
          <div class="history-container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
              <h3 class="form-section-title" style="margin: 0;">給与設定履歴</h3>
              <div style="display: flex; align-items: center; gap: 0.5rem;">
                <label for="salaryHistoryFilter" style="margin: 0; white-space: nowrap;">社員でフィルター:</label>
                <select 
                  id="salaryHistoryFilter" 
                  [(ngModel)]="selectedSalaryHistoryFilter" 
                  (change)="filterSalaryHistory()"
                  class="form-input"
                  style="min-width: 150px;"
                >
                  <option value="">全て</option>
                  <option *ngFor="let emp of salaryEmployees" [value]="emp.employeeNumber">
                    {{ emp.employeeNumber }} - {{ emp.name }}
                  </option>
                </select>
              </div>
            </div>
            <div class="table-container">
              <table class="history-table">
                <thead>
                  <tr>
                    <th>社員番号</th>
                    <th>氏名</th>
                    <th>年</th>
                    <th>月</th>
                    <th>固定的賃金額</th>
                    <th>設定日時</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let record of filteredSalaryHistory">
                    <td>{{ record.employeeNumber }}</td>
                    <td>{{ getEmployeeName(record.employeeNumber) }}</td>
                    <td>{{ record.year }}</td>
                    <td>{{ record.month }}</td>
                    <td>{{ record.amount | number:'1.0-0' }}円</td>
                    <td>{{ formatDateTime(record.createdAt) }}</td>
                  </tr>
                  <tr *ngIf="filteredSalaryHistory.length === 0">
                    <td colspan="6" class="empty-message">履歴がありません</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </ng-container>

        <!-- 賞与ページ -->
        <ng-container *ngIf="currentTab === '賞与'">
          <!-- 賞与設定フォーム -->
          <div class="form-container">
            <form class="bonus-form" (ngSubmit)="saveBonus()">
              <div class="form-row-wide">
                <div class="form-group">
                  <label for="bonusEmployee">社員 <span class="required">*</span></label>
                  <select 
                    id="bonusEmployee" 
                    [(ngModel)]="selectedBonusEmployee" 
                    name="bonusEmployee"
                    class="form-input"
                    [disabled]="isSavingBonus"
                    required
                  >
                    <option value="">選択してください</option>
                    <option *ngFor="let emp of bonusEmployees" [value]="emp.employeeNumber">
                      {{ emp.employeeNumber }} - {{ emp.name }}
                    </option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="bonusYear">年 <span class="required">*</span></label>
                  <select 
                    id="bonusYear" 
                    [(ngModel)]="bonusYear" 
                    name="bonusYear"
                    class="form-input"
                    [disabled]="isSavingBonus"
                    required
                  >
                    <option *ngFor="let year of availableYears" [value]="year">{{ year }}</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="bonusMonth">月 <span class="required">*</span></label>
                  <select 
                    id="bonusMonth" 
                    [(ngModel)]="bonusMonth" 
                    name="bonusMonth"
                    class="form-input"
                    [disabled]="isSavingBonus"
                    required
                  >
                    <option *ngFor="let month of availableMonths" [value]="month">{{ month }}</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="bonusAmount">賞与額（円） <span class="required">*</span></label>
                  <input 
                    type="number" 
                    id="bonusAmount" 
                    [(ngModel)]="bonusAmount" 
                    name="bonusAmount"
                    class="form-input"
                    [disabled]="isSavingBonus"
                    min="1"
                    step="1"
                    (input)="onBonusAmountInput($event)"
                    required
                  >
                </div>
                <div class="form-group form-group-button">
                  <button type="submit" class="submit-button" [disabled]="isSavingBonus">
                    {{ isSavingBonus ? '設定中...' : '賞与を設定' }}
                  </button>
                </div>
              </div>
            </form>
          </div>

          <!-- 賞与履歴表 -->
          <div class="history-container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
              <h3 class="form-section-title" style="margin: 0;">賞与設定履歴</h3>
              <div style="display: flex; align-items: center; gap: 0.5rem;">
                <label for="bonusHistoryFilter" style="margin: 0; white-space: nowrap;">社員でフィルター:</label>
                <select 
                  id="bonusHistoryFilter" 
                  [(ngModel)]="selectedBonusHistoryFilter" 
                  (change)="filterBonusHistory()"
                  class="form-input"
                  style="min-width: 150px;"
                >
                  <option value="">全て</option>
                  <option *ngFor="let emp of bonusEmployees" [value]="emp.employeeNumber">
                    {{ emp.employeeNumber }} - {{ emp.name }}
                  </option>
                </select>
              </div>
            </div>
            <div class="table-container">
              <table class="history-table">
                <thead>
                  <tr>
                    <th>社員番号</th>
                    <th>氏名</th>
                    <th>年</th>
                    <th>月</th>
                    <th>賞与額</th>
                    <th>設定日時</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let record of filteredBonusHistory">
                    <td>{{ record.employeeNumber }}</td>
                    <td>{{ getEmployeeName(record.employeeNumber) }}</td>
                    <td>{{ record.year }}</td>
                    <td>{{ record.month }}</td>
                    <td>{{ record.amount | number:'1.0-0' }}円</td>
                    <td>{{ formatDateTime(record.createdAt) }}</td>
                  </tr>
                  <tr *ngIf="filteredBonusHistory.length === 0">
                    <td colspan="6" class="empty-message">履歴がありません</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </ng-container>

        <!-- 休業・任意保険者ページ -->
        <ng-container *ngIf="currentTab === '休業・任意保険者'">
          <div class="leave-voluntary-page">
            <!-- フィルター -->
            <div class="filter-controls">
              <div class="filter-group">
                <label>表示タイプ:</label>
                <button 
                  class="toggle-button" 
                  [class.active]="leaveVoluntaryListType === 'maternity'"
                  (click)="switchLeaveVoluntaryListType('maternity')"
                >
                  産前産後休業中
                </button>
                <button 
                  class="toggle-button" 
                  [class.active]="leaveVoluntaryListType === 'voluntary'"
                  (click)="switchLeaveVoluntaryListType('voluntary')"
                >
                  任意継続被保険者
                </button>
              </div>
            </div>
            
            <!-- 産前産後休業中テーブル -->
            <div class="table-container" *ngIf="leaveVoluntaryListType === 'maternity'">
              <div *ngIf="isLoadingLeaveVoluntaryList" class="loading-message">
                データを読み込み中です...
              </div>
              <table class="insurance-table" *ngIf="!isLoadingLeaveVoluntaryList">
                <thead>
                  <tr>
                    <th>社員番号</th>
                    <th class="name-column">氏名</th>
                    <th>産前産後休業開始日</th>
                    <th>産前産後休業終了日</th>
                    <th>在籍状況</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let item of filteredLeaveVoluntaryList; trackBy: trackByEmployeeNumber" 
                      (click)="openEmployeeInfoModal(item.employeeNumber)"
                      class="clickable-row">
                    <td>{{ item.employeeNumber }}</td>
                    <td class="name-column">{{ item.name }}</td>
                    <td>{{ item.maternityLeaveStartDate ? formatDate(item.maternityLeaveStartDate) : '-' }}</td>
                    <td>{{ item.maternityLeaveEndDate ? formatDate(item.maternityLeaveEndDate) : '-' }}</td>
                    <td>{{ item.employmentStatus || '在籍' }}</td>
                  </tr>
                  <tr *ngIf="filteredLeaveVoluntaryList.length === 0">
                    <td colspan="5" class="empty-message">データがありません</td>
                  </tr>
                </tbody>
              </table>
            </div>
            
            <!-- 任意継続被保険者テーブル -->
            <div class="table-container" *ngIf="leaveVoluntaryListType === 'voluntary'">
              <div *ngIf="isLoadingLeaveVoluntaryList" class="loading-message">
                データを読み込み中です...
              </div>
              <table class="insurance-table" *ngIf="!isLoadingLeaveVoluntaryList">
                <thead>
                  <tr>
                    <th>社員番号</th>
                    <th class="name-column">氏名</th>
                    <th>退職日</th>
                    <th>健康保険者種別</th>
                    <th>介護保険者種別</th>
                    <th>任意継続終了日</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let item of filteredLeaveVoluntaryList; trackBy: trackByEmployeeNumber" 
                      class="clickable-row">
                    <td (click)="openEmployeeInfoModal(item.employeeNumber)">{{ item.employeeNumber }}</td>
                    <td class="name-column" (click)="openEmployeeInfoModal(item.employeeNumber)">{{ item.name }}</td>
                    <td (click)="openEmployeeInfoModal(item.employeeNumber)">{{ item.resignationDate ? formatDate(item.resignationDate) : '-' }}</td>
                    <td (click)="openEmployeeInfoModal(item.employeeNumber)">{{ item.healthInsuranceType || '-' }}</td>
                    <td (click)="openEmployeeInfoModal(item.employeeNumber)">{{ item.nursingInsuranceType || '-' }}</td>
                    <td (click)="openEmployeeInfoModal(item.employeeNumber)">{{ getVoluntaryEndDate(item) }}</td>
                    <td>
                      <button 
                        class="end-voluntary-button" 
                        (click)="openVoluntaryEndModal(item); $event.stopPropagation()"
                      >
                        終了設定
                      </button>
                    </td>
                  </tr>
                  <tr *ngIf="filteredLeaveVoluntaryList.length === 0">
                    <td colspan="7" class="empty-message">データがありません</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </ng-container>

        <!-- 設定ページ -->
        <ng-container *ngIf="currentTab === '設定'">
          <div class="settings-page">
            <form [formGroup]="settingsForm">
              <!-- 保険料率設定欄 -->
              <div class="settings-container">
                <h3 class="container-title">保険料率設定欄</h3>
                
                <!-- 保険料率設定 -->
                <section class="settings-section">
                  <h4 class="section-title">保険料率設定</h4>
                  <div class="form-grid">
                    <div class="form-group">
                      <label for="prefecture">都道府県 <span class="required">*</span></label>
                      <select 
                        id="prefecture" 
                        formControlName="prefecture" 
                        class="form-input"
                        (change)="onPrefectureChange()"
                      >
                        <option value="">選択してください</option>
                        <option *ngFor="let rate of kenpoRates" [value]="rate.prefecture">
                          {{ rate.prefecture }}
                        </option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label for="healthInsuranceRate">健康保険料率 (%)</label>
                      <input 
                        type="number" 
                        id="healthInsuranceRate" 
                        formControlName="healthInsuranceRate" 
                        class="form-input"
                        step="0.01"
                        min="0"
                        max="100"
                        placeholder="例: 5.0"
                        readonly
                      >
                    </div>
                    <div class="form-group">
                      <label for="nursingInsuranceRate">介護保険料率 (%)</label>
                      <input 
                        type="number" 
                        id="nursingInsuranceRate" 
                        formControlName="nursingInsuranceRate" 
                        class="form-input"
                        step="0.01"
                        min="0"
                        max="100"
                        placeholder="例: 1.0"
                        readonly
                      >
                    </div>
                    <div class="form-group">
                      <label for="pensionInsuranceRate">厚生年金保険料率 (%)</label>
                      <input 
                        type="number" 
                        id="pensionInsuranceRate" 
                        formControlName="pensionInsuranceRate" 
                        class="form-input"
                        placeholder="例: 9.15"
                        step="0.01"
                        min="0"
                        max="100"
                        (keydown)="onPensionInsuranceRateKeydown($event)"
                        (input)="onPensionInsuranceRateInput($event)"
                        (compositionstart)="onPensionInsuranceRateCompositionStart($event)"
                        (compositionend)="onPensionInsuranceRateCompositionEnd($event)"
                      >
                    </div>
                  </div>
                  <div class="section-actions">
                    <button type="button" class="save-section-button" (click)="saveInsuranceRates()">
                      保険料率設定を保存
                    </button>
                  </div>
                </section>

                <!-- 協会けんぽ保険料率管理 -->
                <section class="settings-section">
                  <h4 class="section-title">協会けんぽ保険料率管理</h4>
                  <div class="form-description">
                    <p>現在設定されている協会けんぽの保険料率データをダウンロードしたり、JSONファイルをアップロードして保険料率を更新できます。</p>
                  </div>
                  <div class="file-management-actions">
                    <button type="button" class="download-button" (click)="downloadKenpoRates()">
                      kenpo-rates.jsonをダウンロード
                    </button>
                    <div class="upload-group">
                      <label for="kenpoRatesFile" class="upload-label">
                        <input 
                          type="file" 
                          id="kenpoRatesFile" 
                          accept=".json"
                          (change)="onKenpoRatesFileSelected($event)"
                          style="display: none;"
                        >
                        <span class="upload-button">JSONファイルをアップロード</span>
                      </label>
                      <span *ngIf="selectedKenpoRatesFileName" class="selected-file-name">
                        {{ selectedKenpoRatesFileName }}
                      </span>
                    </div>
                    <button 
                      *ngIf="selectedKenpoRatesFile" 
                      type="button" 
                      class="apply-button" 
                      (click)="applyKenpoRates()"
                    >
                      保険料率を適用
                    </button>
                  </div>
                </section>

                <!-- 等級表管理 -->
                <section class="settings-section">
                  <h4 class="section-title">等級表管理</h4>
                  <div class="form-description">
                    <p>現在設定されている標準報酬月額等級表データをダウンロードしたり、JSONファイルをアップロードして等級表を更新できます。</p>
                  </div>
                  <div class="file-management-actions">
                    <button type="button" class="download-button" (click)="downloadGradeTable()">
                      等級.jsonをダウンロード
                    </button>
                    <div class="upload-group">
                      <label for="gradeTableFile" class="upload-label">
                        <input 
                          type="file" 
                          id="gradeTableFile" 
                          accept=".json"
                          (change)="onGradeTableFileSelected($event)"
                          style="display: none;"
                        >
                        <span class="upload-button">JSONファイルをアップロード</span>
                      </label>
                      <span *ngIf="selectedGradeTableFileName" class="selected-file-name">
                        {{ selectedGradeTableFileName }}
                      </span>
                    </div>
                    <button 
                      *ngIf="selectedGradeTableFile" 
                      type="button" 
                      class="apply-button" 
                      (click)="applyGradeTable()"
                    >
                      等級表を適用
                    </button>
                  </div>
                </section>

                <!-- 保険料を現金で徴収する社員を設定 -->
                <section class="settings-section">
                  <h4 class="section-title">保険料を現金で徴収する社員を設定</h4>
                  <div class="form-group">

                    <div class="cash-collection-employees">
                      <div class="employee-select-container">
                        <select 
                          [(ngModel)]="selectedCashCollectionEmployee" 
                          [ngModelOptions]="{standalone: true}"
                          class="form-input"
                          (change)="onCashCollectionEmployeeChange()"
                        >
                          <option value="">社員を選択してください</option>
                          <option *ngFor="let emp of employees" [value]="emp.employeeNumber">
                            {{ emp.employeeNumber }} - {{ emp.name }}
                          </option>
                        </select>
                        <button 
                          type="button" 
                          class="add-employee-button" 
                          (click)="addCashCollectionEmployee()"
                          [disabled]="!selectedCashCollectionEmployee || isCashCollectionEmployeeAdded(selectedCashCollectionEmployee)"
                        >
                          追加
                        </button>
                      </div>
                      <div class="selected-employees-list" *ngIf="cashCollectionEmployees.length > 0">
                        <h5>現金徴収する社員一覧</h5>
                        <ul class="employee-list">
                          <li *ngFor="let emp of cashCollectionEmployees">
                            <span>{{ emp.employeeNumber }} - {{ emp.name }}</span>
                            <button 
                              type="button" 
                              class="remove-employee-button" 
                              (click)="removeCashCollectionEmployee(emp.employeeNumber)"
                            >
                              削除
                            </button>
                          </li>
                        </ul>
                      </div>
                    </div>
                    <div class="form-description">
                      <p>現金で徴収する社員の場合、端数が50未満なら切り捨て、50以上なら切り上げとして計算されます。</p>
                    </div>
                  </div>
                  <div class="section-actions">
                    <button type="button" class="save-section-button" (click)="saveCashCollectionEmployees()">
                      現金徴収社員設定を保存
                    </button>
                  </div>
                </section>
              </div>
            </form>
          </div>
        </ng-container>
      </div>
    </main>
  </div>
</div>

<!-- 社員情報モーダル -->
<div class="modal-overlay" *ngIf="showEmployeeInfoModal" (click)="closeEmployeeInfoModal()">
  <div class="modal-content employee-info-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">社員情報</h2>
      <button class="modal-close-button" (click)="closeEmployeeInfoModal()">×</button>
    </div>
    <div class="modal-body">
      <div *ngIf="selectedEmployeeInfo" class="employee-info-container">
        <!-- 基本情報 -->
        <div class="info-section">
          <h3 class="section-title">基本情報</h3>
          <div class="info-grid">
            <div class="info-item">
              <span class="info-label">社員番号:</span>
              <span class="info-value">{{ selectedEmployeeInfo.employeeNumber }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">氏名:</span>
              <span class="info-value">{{ selectedEmployeeInfo.name }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">雇用形態:</span>
              <span class="info-value">{{ selectedEmployeeInfo.employmentType || '-' }}</span>
            </div>
            <div class="info-item" *ngIf="selectedEmployeeInfo.healthNursingGrade">
              <span class="info-label">健康介護保険等級:</span>
              <span class="info-value">{{ selectedEmployeeInfo.healthNursingGrade }}</span>
            </div>
            <div class="info-item" *ngIf="selectedEmployeeInfo.pensionGrade">
              <span class="info-label">厚生年金保険等級:</span>
              <span class="info-value">{{ selectedEmployeeInfo.pensionGrade }}</span>
            </div>
          </div>
        </div>

        <!-- 被保険者種別 -->
        <div class="info-section">
          <h3 class="section-title">被保険者種別</h3>
          <div class="info-grid">
            <div class="info-item">
              <span class="info-label">健康保険者種別:</span>
              <span class="info-value">{{ selectedEmployeeInfo.healthInsuranceType || '-' }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">介護保険者種別:</span>
              <span class="info-value">{{ selectedEmployeeInfo.nursingInsuranceType || '-' }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">厚生年金保険者種別:</span>
              <span class="info-value">{{ selectedEmployeeInfo.pensionInsuranceType || '-' }}</span>
            </div>
          </div>
        </div>

        <!-- 産前産後休業 -->
        <div class="info-section">
          <h3 class="section-title">産前産後休業</h3>
          <div class="info-grid">
            <div class="info-item">
              <span class="info-label">産前産後休業期間:</span>
              <span class="info-value">
                <span *ngIf="selectedEmployeeInfo.maternityLeaveStartDate && selectedEmployeeInfo.maternityLeaveEndDate">
                  {{ formatDate(selectedEmployeeInfo.maternityLeaveStartDate) }} ～ {{ formatDate(selectedEmployeeInfo.maternityLeaveEndDate) }}
                </span>
                <span *ngIf="!selectedEmployeeInfo.maternityLeaveStartDate || !selectedEmployeeInfo.maternityLeaveEndDate">無し</span>
              </span>
            </div>
          </div>
        </div>

        <!-- 在籍状況 -->
        <div class="info-section">
          <h3 class="section-title">在籍状況</h3>
          <div class="info-grid">
            <div class="info-item">
              <span class="info-label">在籍状況:</span>
              <span class="info-value">{{ selectedEmployeeInfo.employmentStatus || '在籍' }}</span>
            </div>
            <div class="info-item" *ngIf="selectedEmployeeInfo.employmentStatus === '在籍' && selectedEmployeeInfo.joinDate">
              <span class="info-label">入社月:</span>
              <span class="info-value">{{ formatJoinDate(selectedEmployeeInfo.joinDate) }}</span>
            </div>
            <div class="info-item" *ngIf="selectedEmployeeInfo.resignationDate">
              <span class="info-label">退職日:</span>
              <span class="info-value">{{ formatDate(selectedEmployeeInfo.resignationDate) }}</span>
            </div>
          </div>
        </div>

        <!-- 年度報酬加算額 -->
        <div class="info-section" *ngIf="selectedEmployeeInfo.annualRewardAddition !== undefined">
          <h3 class="section-title">年度報酬加算額</h3>
          <div class="info-grid">
            <div class="info-item">
              <span class="info-label">{{ selectedEmployeeInfo.fiscalYear }}年度報酬加算額:</span>
              <span class="info-value">{{ selectedEmployeeInfo.annualRewardAddition | number:'1.0-0' }}円</span>
            </div>
            <div class="info-item" *ngIf="selectedEmployeeInfo.fiscalYearBonusCount !== undefined">
              <span class="info-label">{{ selectedEmployeeInfo.fiscalYear }}年度賞与支給回数:</span>
              <span class="info-value">{{ selectedEmployeeInfo.fiscalYearBonusCount }}回</span>
            </div>
          </div>
        </div>
      </div>
      <div *ngIf="!selectedEmployeeInfo" class="loading-message">
        情報を読み込み中...
      </div>
    </div>
    <div class="modal-footer">
      <button class="modal-button" (click)="closeEmployeeInfoModal()">閉じる</button>
    </div>
  </div>
</div>

<!-- 任意継続終了設定モーダル -->
<div class="modal-overlay" *ngIf="showVoluntaryEndModal" (click)="closeVoluntaryEndModal()">
  <div class="modal-content voluntary-end-modal" (click)=" $event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">任意継続終了設定</h2>
      <button class="modal-close-button" (click)="closeVoluntaryEndModal()">×</button>
    </div>
    <div class="modal-body">
      <div *ngIf="selectedVoluntaryEmployee" class="voluntary-end-container">
        <div class="info-section">
          <div class="info-item">
            <span class="info-label">社員番号:</span>
            <span class="info-value">{{ selectedVoluntaryEmployee.employeeNumber }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">氏名:</span>
            <span class="info-value">{{ selectedVoluntaryEmployee.name }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">退職日:</span>
            <span class="info-value">{{ selectedVoluntaryEmployee.resignationDate ? formatDate(selectedVoluntaryEmployee.resignationDate) : '-' }}</span>
          </div>
        </div>
        
        <form [formGroup]="voluntaryEndForm" class="voluntary-end-form">
          <div class="form-group">
            <label for="voluntaryEndDate">任意継続終了日 <span class="required">*</span></label>
            <input 
              type="date" 
              id="voluntaryEndDate" 
              formControlName="voluntaryEndDate" 
              class="form-input"
              [max]="getMaxVoluntaryEndDate()"
            >
            <div *ngIf="voluntaryEndForm.get('voluntaryEndDate')?.invalid && voluntaryEndForm.get('voluntaryEndDate')?.touched" class="error-message">
              任意継続終了日を入力してください
            </div>
            <div *ngIf="voluntaryEndForm.get('voluntaryEndDate')?.value && getMaxVoluntaryEndDate() && voluntaryEndForm.get('voluntaryEndDate')?.value > getMaxVoluntaryEndDate()" class="error-message">
              任意継続終了日は退職日の翌日から2年以内である必要があります
            </div>
            <div class="form-hint">
              退職日の翌日から2年間まで設定可能です。
            </div>
          </div>
        </form>
      </div>
    </div>
    <div class="modal-footer">
      <button class="modal-button cancel-button" (click)="closeVoluntaryEndModal()">キャンセル</button>
      <button 
        class="modal-button submit-button" 
        (click)="saveVoluntaryEndDate()"
        [disabled]="voluntaryEndForm.invalid || isSavingVoluntaryEnd"
      >
        {{ isSavingVoluntaryEnd ? '保存中...' : '保存' }}
      </button>
    </div>
  </div>
</div>

