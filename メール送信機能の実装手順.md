# メール送信機能の実装手順

## 概要
入社手続きページで社員を追加する際、入力したメールアドレスにアプリのURLが記載されたメールを自動送信する機能です。

## 実装方法（2つの選択肢）

### 方法1: Firebase ExtensionsのTrigger Emailを使用（推奨・簡単）

#### 手順

1. **Firebaseコンソールで拡張機能をインストール**
   - Firebaseコンソール（https://console.firebase.google.com/）にアクセス
   - プロジェクト「kensyu10117」を選択
   - 左メニューから「拡張機能」を選択
   - 「拡張機能を探索」をクリック
   - 「Trigger Email」を検索してインストール

2. **SMTPサーバーの設定**
   - SendGrid、Mailgun、GmailなどのSMTPサーバーの認証情報を入力
   - **SendGridを使用する場合（推奨）**：
     - SendGridアカウントを作成（無料プランあり）
     - APIキーを取得
     - 拡張機能の設定で以下を入力：
       - SMTP Host: `smtp.sendgrid.net`
       - SMTP Port: `587`
       - SMTP Username: `apikey`
       - SMTP Password: （取得したAPIキー）
       - From Email: `noreply@yourcompany.com`（SendGridで認証済みのメールアドレス）

3. **コレクション名の設定**
   - メール送信をトリガーするコレクション名: `mail`（デフォルト）

4. **完了**
   - インストール完了後、アプリから`mail`コレクションにドキュメントを追加するだけでメールが送信されます

#### メリット
- 設定が簡単
- Firebaseが自動的にメール送信を管理
- メール送信の失敗時のリトライ機能が自動

---

### 方法2: Firebase Functionsで直接メール送信（SMTP設定が必要）

#### 手順

1. **nodemailerパッケージをインストール**
   ```bash
   cd functions
   npm install nodemailer
   npm install --save-dev @types/nodemailer
   ```

2. **環境変数を設定**
   - Firebaseコンソールで環境変数を設定：
     - Functions → 設定 → 環境変数
     - 以下の変数を追加：
       - `SMTP_HOST`: SMTPサーバーのホスト名（例: `smtp.gmail.com`）
       - `SMTP_PORT`: SMTPポート（例: `587`）
       - `SMTP_USER`: SMTPユーザー名
       - `SMTP_PASSWORD`: SMTPパスワード
       - `SMTP_FROM`: 送信元メールアドレス

3. **Firebase Functionsをデプロイ**
   ```bash
   cd functions
   npm run build
   firebase deploy --only functions
   ```

#### メリット
- より細かい制御が可能
- カスタムロジックを追加しやすい

---

## 現在の実装状況

現在のコードは、以下の2つの方法に対応しています：

1. **SMTP設定がある場合**: nodemailerを使用して直接メール送信
2. **SMTP設定がない場合**: Firestoreの`mail`コレクションに保存（Trigger Email拡張機能が自動的にメール送信）

## 推奨される実装

**方法1（Trigger Email拡張機能）を推奨**します。理由：
- 設定が簡単
- メール送信の管理が自動化される
- エラーハンドリングが自動

## 次のステップ

1. FirebaseコンソールでTrigger Email拡張機能をインストール
2. SMTPサーバー（SendGrid推奨）の設定を行う
3. アプリをテストしてメール送信を確認

## トラブルシューティング

### メールが送信されない場合

1. **Firebaseコンソールでログを確認**
   - Functions → ログ でエラーを確認

2. **Firestoreのmailコレクションを確認**
   - Firestore → mailコレクションにドキュメントが追加されているか確認
   - ドキュメントの`delivery`フィールドで送信状況を確認

3. **SMTP設定を確認**
   - 環境変数が正しく設定されているか確認
   - SMTPサーバーの認証情報が正しいか確認

## 参考リンク

- [Firebase Extensions - Trigger Email](https://firebase.google.com/products/extensions/firestore-send-email)
- [SendGrid公式サイト](https://sendgrid.com/)
- [Gmailアプリパスワードの設定方法](https://support.google.com/accounts/answer/185833)

